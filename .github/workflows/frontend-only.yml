name: frontend

on:
  push:
    branches: [ main ]
    paths:
      - 'index.html'
      - '*.css'
      - '*.js'
      - 'firebase.json'
      - 'CNAME'
      - 'src/**'
  workflow_dispatch:

env:
  PROJECT_ID: kinggrouptech-93908
  FRONTEND_URL: https://kinggrouptech.com
  FIREBASE_URL: https://kinggrouptech-93908.web.app

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js with Cache
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Firebase CLI with Cache
      run: |
        npm install -g firebase-tools
        
    - name: â˜ï¸ Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        
    - name: ğŸ” Authenticate Firebase
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud config set project ${{ env.PROJECT_ID }}
        firebase use ${{ env.PROJECT_ID }} --token "$(gcloud auth print-access-token)"
        
    - name: ğŸ§ª Frontend Validation Tests
      run: |
        echo "ğŸ” Testing frontend files..."
        
        # Verificar arquivos essenciais
        [ -f "index.html" ] && echo "âœ… index.html found" || { echo "âŒ index.html missing"; exit 1; }
        [ -f "firebase.json" ] && echo "âœ… firebase.json found" || { echo "âŒ firebase.json missing"; exit 1; }
        
        # Verificar estrutura HTML
        grep -q "<title>" index.html && echo "âœ… HTML title found"
        grep -q "KingGroup" index.html && echo "âœ… KingGroup branding found"
        
        # Listar todos os assets
        echo "ğŸ“ Frontend assets:"
        ls -la *.html *.css *.js 2>/dev/null || echo "ğŸ“ Basic files only"
        
        echo "âœ… Frontend validation completed"
        
    - name: ğŸ” Pre-Deploy Configuration Check
      run: |
        echo "ğŸ” Checking Firebase configuration..."
        if [ -f "firebase.json" ]; then
          echo "âœ… firebase.json found"
          cat firebase.json | jq . > /dev/null && echo "âœ… Valid JSON format" || echo "âš ï¸ JSON format warning"
        fi
        
        # Verificar CNAME se existir
        if [ -f "CNAME" ]; then
          echo "âœ… CNAME found: $(cat CNAME)"
        fi
        
    - name: ğŸš€ Deploy to Firebase Hosting
      run: |
        echo "ğŸš€ Starting deployment to Firebase Hosting..."
        firebase deploy --only hosting --token "$(gcloud auth print-access-token)" --force
        echo "âœ… Frontend deployment completed"
        
    - name: ğŸ” Post-Deploy Health Check
      run: |
        echo "ğŸ” Performing frontend health check..."
        sleep 15  # Wait for deployment to propagate
        
        # Test Firebase URL
        curl -f ${{ env.FIREBASE_URL }} && echo "âœ… Firebase URL accessible" || echo "âš ï¸ Firebase URL check failed"
        
        # Test custom domain if configured
        curl -f ${{ env.FRONTEND_URL }} && echo "âœ… Custom domain accessible" || echo "âš ï¸ Custom domain check failed"
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        rm -f /tmp/gcp-key.json
        
    - name: âœ… Frontend Deployment Success
      run: |
        echo "ğŸ‰ Frontend deployed successfully!"
        echo "ğŸŒ Website: ${{ env.FRONTEND_URL }}"
        echo "ğŸ”¥ Firebase: ${{ env.FIREBASE_URL }}"
        echo "ğŸ“… Deployed at: $(date)"
        echo "ğŸ¯ Ready for production traffic!"

